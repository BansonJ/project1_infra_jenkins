// jenkinsfile (Declarative Pipeline)

pipeline {
    // 1. 에이전트 설정: 파이프라인이 실행될 Jenkins 에이전트를 지정합니다.
    agent any

    // 2. 환경 변수 설정: Ansible 실행에 필요한 변수를 정의합니다.
    environment {
        // Jenkins Credential ID (ansible 유저의 SSH 개인 키)
        ANSIBLE_SSH_CREDENTIALS = 'ansible_user_key'
        ANSIBLE_INVENTORY_FILE = 'inventory'
    }

    // 3. 옵션 설정
    options {
        // 이전 빌드 결과와 관계없이 workspace를 정리
        skipDefaultCheckout()
    }

    // 4. 파이프라인 실행 단계
    stages {
        // Git 저장소에서 Ansible 프로젝트 파일들을 가져오는 단계
        stage('Checkout Code') {
            steps {
                // 저장소 URL 및 브랜치 정보를 Jenkins Job 설정에서 가져옵니다.
                checkout scm
            }
        }

        // 5. Ansible 배포 단계: sshagent 블록으로 모든 Ansible 실행을 감쌈
        stage('Ansible Deployment') {
            steps {
                // Jenkins Credential ID에 해당하는 키를 메모리(SSH Agent)에 로드합니다.
                sshagent(credentials: ["${ANSIBLE_SSH_CREDENTIALS}"]) {
                    sh """
                    #sudo -u ansible로 권한을 전환하고, --key-file 없이 Ansible 실행

                    echo "--- 1. Running K8s Base Setup ---"
                    sudo -u ansible ansible-playbook -i ansible/${ANSIBLE_INVENTORY_FILE} ansible/k8s-playbook.yaml

                    echo "--- 2. Running MetalLB Setup ---"
                    sudo -u ansible ansible-playbook -i ansible-metallb/${ANSIBLE_INVENTORY_FILE} ansible-metallb/metallb-playbook.yaml

                    echo "--- 3. Running WAF Setup ---"
                    sudo -u ansible ansible-playbook -i ansible-waf/${ANSIBLE_INVENTORY_FILE} ansible-waf/waf-playbook.yaml

                    echo "--- 4. Running Monitoring Setup ---"
                    sudo -u ansible ansible-playbook -i ansible-monitoring/${ANSIBLE_INVENTORY_FILE} ansible-monitoring/site.yml
                    
                    #echo "--- 5. Running DB Setup ---"
                    #sudo -u ansible ansible-playbook -i ansible-db/${ANSIBLE_INVENTORY_FILE} ansible-db/db.yaml
                    """
                }
            }
        }
    }

    // 5. 후처리 단계: 빌드가 성공 또는 실패했을 때 알림을 보냅니다.
    post {
        always {
            // 빌드 성공/실패 여부에 관계없이 실행
            echo "Ansible Pipeline finished."
        }
        success {
            echo "Deployment successful!"
        }
        failure {
            echo "Deployment failed! Check logs."
        }
    }
}
