// Jenkinsfile (Declarative Pipeline)

pipeline {
    // 1. ì—ì´ì „íŠ¸ ì„¤ì •: íŒŒì´í”„ë¼ì¸ì´ ì‹¤í–‰ë  Jenkins ì—ì´ì „íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
    agent any

    // 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •: Ansible ì‹¤í–‰ì— í•„ìš”í•œ ë³€ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
    environment {
        // NOTE: ì‹¤ì œ í‚¤ íŒŒì¼ ì´ë¦„ê³¼ Jenkins Credential IDë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
        // ssh-credentials-idëŠ” Jenkinsì— ë“±ë¡ëœ SSH ìê²©ì¦ëª… IDì…ë‹ˆë‹¤.
        ANSIBLE_SSH_CREDENTIALS = 'ansible_user_key'
        ANSIBLE_INVENTORY_FILE = 'inventory' // ëŒ€ë¶€ë¶„ì˜ í”„ë¡œì íŠ¸ê°€ ì‚¬ìš©í•˜ëŠ” ì¸ë²¤í† ë¦¬ íŒŒì¼ ì´ë¦„
    }

    // 3. ì˜µì…˜ ì„¤ì •: Git í´ë¡  ë“± íŒŒì´í”„ë¼ì¸ì˜ ì „ì—­ ì˜µì…˜ì„ ì •ì˜í•©ë‹ˆë‹¤.
    options {
        // ì´ì „ ë¹Œë“œ ê²°ê³¼ì™€ ê´€ê³„ì—†ì´ workspaceë¥¼ ì •ë¦¬ (ê¶Œì¥)
        skipDefaultCheckout()
    }

    // 4. íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë‹¨ê³„
    stages {
        // Git ì €ì¥ì†Œì—ì„œ Ansible í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ë‹¨ê³„
        stage('Checkout Code') {
            steps {
                // ì €ì¥ì†Œ URL ë° ë¸Œëœì¹˜ ì •ë³´ë¥¼ Jenkins Job ì„¤ì •ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                checkout scm
            }
        }

        // 1. K8s ê¸°ë³¸ ì„¤ì¹˜/ì„¤ì • (ansible/ ë””ë ‰í† ë¦¬)
        stage('Run Base K8s Setup') {
            steps {
                sh """
                echo "Running K8s Base Setup from ansible/k8s-playbook.yaml"
                sudo -u ansible ansible-playbook -i ansible/${ANSIBLE_INVENTORY_FILE} ansible/k8s-playbook.yaml \
                    --key-file /home/ansible/.ssh/${ANSIBLE_SSH_CREDENTIALS}
                """
            }
        }

        // 2. MetalLB ì„¤ì¹˜/ì„¤ì • (ansible-metallb/ ë””ë ‰í† ë¦¬)
        stage('Run MetalLB Setup') {
            steps {
                sh """
                echo "Running MetalLB Setup from ansible-metallb/k8s-playbook.yaml"
                sudo -u ansible ansible-playbook -i ansible-metallb/${ANSIBLE_INVENTORY_FILE} ansible-metallb/metallb-playbook.yaml \
                    --key-file /home/ansible/.ssh/${ANSIBLE_SSH_CREDENTIALS}
                """
            }
        }

        // 3. WAF ì„¤ì¹˜/ì„¤ì • (ansible-waf/ ë””ë ‰í† ë¦¬)
        stage('Run WAF Setup') {
            steps {
                sh """
                echo "Running WAF Setup from ansible-waf/waf-playbook.yaml"
                sudo -u ansible ansible-playbook -i ansible-waf/${ANSIBLE_INVENTORY_FILE} ansible-waf/waf-playbook.yaml \
                    --key-file /home/ansible/.ssh/${ANSIBLE_SSH_CREDENTIALS}
                """
            }
        }

        // 4. Monitoring ì„¤ì¹˜/ì„¤ì • (ansible-monitoring/ ë””ë ‰í† ë¦¬)
        stage('Run Monitoring Setup') {
            steps {
                sh """
                echo "Running Monitoring Setup from ansible-monitoring/site.yml"
                sudo -u ansible ansible-playbook -i ansible-monitoring/${ANSIBLE_INVENTORY_FILE} ansible-monitoring/site.yml \
                    --key-file /home/ansible/.ssh/${ANSIBLE_SSH_CREDENTIALS}
                """
            }
        }
    }

    // 5. í›„ì²˜ë¦¬ ë‹¨ê³„: ë¹Œë“œê°€ ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨í–ˆì„ ë•Œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.
    post {
        always {
            // ë¹Œë“œ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì— ê´€ê³„ì—†ì´ ì‹¤í–‰
            echo "Ansible Pipeline finished."
        }
        success {
            echo "Deployment successful! ğŸš€"
        }
        failure {
            echo "Deployment failed! Check logs. âŒ"
        }
    }
}
