// Jenkinsfile (Declarative Pipeline)

pipeline {
    // 1. ì—ì´ì „íŠ¸ ì„¤ì •: íŒŒì´í”„ë¼ì¸ì´ ì‹¤í–‰ë  Jenkins ì—ì´ì „íŠ¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
    agent any

    // 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •: Ansible ì‹¤í–‰ì— í•„ìš”í•œ ë³€ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
    environment {
        // Jenkins Credential ID (ansible ìœ ì €ì˜ SSH ê°œì¸ í‚¤)
        ANSIBLE_SSH_CREDENTIALS = 'ansible_user_key' 
        ANSIBLE_INVENTORY_FILE = 'inventory'
    }

    // 3. ì˜µì…˜ ì„¤ì •
    options {
        // ì´ì „ ë¹Œë“œ ê²°ê³¼ì™€ ê´€ê³„ì—†ì´ workspaceë¥¼ ì •ë¦¬ (ê¶Œì¥)
        skipDefaultCheckout()
    }

    // 4. íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë‹¨ê³„
    stages {
        // Git ì €ì¥ì†Œì—ì„œ Ansible í”„ë¡œì íŠ¸ íŒŒì¼ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ë‹¨ê³„
        stage('Checkout Code') {
            steps {
                // ì €ì¥ì†Œ URL ë° ë¸Œëœì¹˜ ì •ë³´ë¥¼ Jenkins Job ì„¤ì •ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
                checkout scm
            }
        }

        // 5. Ansible ë°°í¬ ë‹¨ê³„: sshagent ë¸”ë¡ìœ¼ë¡œ ëª¨ë“  Ansible ì‹¤í–‰ì„ ê°ìŒˆ
        stage('Ansible Deployment') {
            steps {
                // Jenkins Credential IDì— í•´ë‹¹í•˜ëŠ” í‚¤ë¥¼ ë©”ëª¨ë¦¬(SSH Agent)ì— ë¡œë“œí•©ë‹ˆë‹¤.
                sshagent(credentials: ["${ANSIBLE_SSH_CREDENTIALS}"]) {
                    sh """
                    # sudo -u ansibleë¡œ ê¶Œí•œì„ ì „í™˜í•˜ê³ , --key-file ì—†ì´ Ansible ì‹¤í–‰
                    
                    echo "--- 1. Running K8s Base Setup ---"
                    sudo -u ansible ansible-playbook -i ansible/${ANSIBLE_INVENTORY_FILE} ansible/k8s-playbook.yaml

                    echo "--- 2. Running WAF Setup ---"
                    sudo -u ansible ansible-playbook -i ansible-waf/${ANSIBLE_INVENTORY_FILE} ansible-waf/waf-playbook.yaml

                    echo "--- 3. Running MetalLB Setup ---"
                    sudo -u ansible ansible-playbook -i ansible-metallb/${ANSIBLE_INVENTORY_FILE} ansible-metallb/metallb-playbook.yaml

                    echo "--- 4. Running Monitoring Setup ---"
                    sudo -u ansible ansible-playbook -i ansible-monitoring/${ANSIBLE_INVENTORY_FILE} ansible-monitoring/site.yml
                    """
                }
            }
        }
    }

    // 5. í›„ì²˜ë¦¬ ë‹¨ê³„: ë¹Œë“œê°€ ì„±ê³µ ë˜ëŠ” ì‹¤íŒ¨í–ˆì„ ë•Œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.
    post {
        always {
            // ë¹Œë“œ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì— ê´€ê³„ì—†ì´ ì‹¤í–‰
            echo "Ansible Pipeline finished."
        }
        success {
            echo "Deployment successful! ğŸš€"
        }
        failure {
            echo "Deployment failed! Check logs. âŒ"
        }
    }
}
