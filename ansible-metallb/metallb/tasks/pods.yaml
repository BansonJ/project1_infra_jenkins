---
- name: 환경별 설정 파일 로드
  include_vars:
    file: "pods_vars.yaml"

# --- 0. Pre-Checks ---
- name: 01_CHECK - Wait for Kubernetes API to be reachable
  ansible.builtin.command: kubectl version --output=json
  register: k8s_api_status
  retries: 50
  delay: 10
  until: k8s_api_status.rc == 0 and '"serverVersion"' in k8s_api_status.stdout

- name: 02_CHECK - Wait for CoreDNS to be Ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    --namespace kube-system
    -l k8s-app=kube-dns
    --timeout=300s

# --- 1. MetalLB Installation ---
- name: 10_METALLB_GET - Download MetalLB manifests
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml"
    dest: "/tmp/metallb.yaml"

- name: 11_METALLB_APPLY - Apply MetalLB manifest
  ansible.builtin.command: kubectl apply -f /tmp/metallb.yaml

- name: 12_METALLB_WAIT - Wait for Controller pods Ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    -n metallb-system
    -l component=controller
    --timeout=300s

- name: 13_METALLB_WAIT - Wait for Speaker pods Ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    -n metallb-system
    -l component=speaker
    --timeout=300s

# --- 2. MetalLB Config & Webhook Bypass ---
- name: 21_METALLB_WEBHOOK_DEL - Delete ALL MetalLB Webhook Configurations (Bypass Network Error)
  ansible.builtin.shell: |
    kubectl delete validatingwebhookconfigurations metallb-webhook-configuration --ignore-not-found || true
    kubectl delete mutatingwebhookconfigurations metallb-webhook-configuration --ignore-not-found || true
  ignore_errors: yes

# --- 4. Ingress Controller Installation ---
- name: 40_INGRESS_INSTALL - Install NGINX Ingress Controller
  ansible.builtin.command: >
    kubectl apply -f
    https://raw.githubusercontent.com/kubernetes/ingress-nginx/{{ ingress_controller_version }}/deploy/static/provider/cloud/deploy.yaml

- name: 41_INGRESS_WAIT - Wait for Ingress controller pods Ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    -n ingress-nginx
    -l app.kubernetes.io/component=controller
    --timeout=600s

# --- 5. Ingress Config & Webhook Bypass ---
- name: 50_INGRESS_WEBHOOK_DEL - Delete ALL Ingress Webhook Configurations (Critical Bypass)
  ansible.builtin.shell: |
    kubectl delete validatingwebhookconfigurations ingress-nginx-admission --ignore-not-found || true
    kubectl delete mutatingwebhookconfigurations ingress-nginx-admission --ignore-not-found || true
  ignore_errors: yes

# --- 6. Cleanup & Results ---
- name: 60_CLEANUP - Clean up temp manifests
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /tmp/metallb.yaml
