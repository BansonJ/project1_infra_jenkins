---
# =====================================================================
# 0. firewalld ì„¤ì • (control_plane + workers)
# =====================================================================
- name: 0. Configure firewalld on Kubernetes nodes
  hosts: control_plane,workers
  become: true
  gather_facts: false

  vars:
    # metallb/vars/main.yml ì—ì„œ ê°€ì ¸ë‹¤ ì“°ê¸°
    pod_cidr: "{{ hostvars[groups['control_plane'][0]].pod_cidr | default('10.244.0.0/16') }}"
    calico_vxlan_if: "{{ hostvars[groups['control_plane'][0]].calico_vxlan_if | default('vxlan.calico') }}"

  # metallb/vars/main.yml ì˜ í¬íŠ¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©
  # (í•´ë‹¹ ë³€ìˆ˜ëŠ” control1 ì—ì„œ ë¡œë“œëœë‹¤ê³  ê°€ì •)
  pre_tasks:
    - name: 0-0. Load firewall vars from metallb role (only once)
      ansible.builtin.include_vars:
        file: "metallb/vars/main.yml"
      run_once: true
      delegate_to: localhost

  tasks:
    - name: 0-1. Ensure firewalld installed
      ansible.builtin.yum:
        name: firewalld
        state: present

    - name: 0-2. Enable and start firewalld
      ansible.builtin.service:
        name: firewalld
        state: started
        enabled: true

    # SSHëŠ” í•­ìƒ í—ˆìš©
    - name: 0-3. Allow SSH service in public zone
      ansible.builtin.firewalld:
        service: ssh
        zone: public
        permanent: yes
        immediate: yes
        state: enabled

    # ğŸ”¹ Pod CIDR ì„ trusted zone ìœ¼ë¡œ ì¶”ê°€
    - name: 0-4. Allow Pod CIDR {{ pod_cidr }} as trusted source
      ansible.builtin.firewalld:
        zone: trusted
        source: "{{ pod_cidr }}"
        permanent: yes
        immediate: yes
        state: enabled

    # ğŸ”¹ Calico VXLAN ì¸í„°í˜ì´ìŠ¤ë¥¼ trusted zone ìœ¼ë¡œ
    - name: 0-5. Allow Calico VXLAN interface {{ calico_vxlan_if }} in trusted zone
      ansible.builtin.firewalld:
        zone: trusted
        interface: "{{ calico_vxlan_if }}"
        permanent: yes
        immediate: yes
        state: enabled
      ignore_errors: yes   # ì¸í„°í˜ì´ìŠ¤ ì´ë¦„ ë‹¤ë¥´ë©´ ê·¸ëƒ¥ ë„˜ì–´ê°€ê²Œ

    # ğŸ”¹ control/worker ê³µí†µ TCP í¬íŠ¸ í—ˆìš©
    - name: 0-6. Open common Kubernetes/Calico TCP ports
      ansible.builtin.firewalld:
        port: "{{ item.port }}/tcp"
        zone: public
        permanent: yes
        immediate: yes
        state: enabled
      loop: "{{ k8s_common_ports }}"

    # ğŸ”¹ control/worker ê³µí†µ UDP í¬íŠ¸ í—ˆìš©
    - name: 0-7. Open common Kubernetes/Calico UDP ports
      ansible.builtin.firewalld:
        port: "{{ item }}/udp"
        zone: public
        permanent: yes
        immediate: yes
        state: enabled
      loop: "{{ k8s_udp_ports }}"

    # ğŸ”¹ control-plane ì „ìš© í¬íŠ¸ (control1~3 ë§Œ)
    - name: 0-8. Open control-plane only TCP ports
      ansible.builtin.firewalld:
        port: "{{ item.port }}/tcp"
        zone: public
        permanent: yes
        immediate: yes
        state: enabled
      loop: "{{ k8s_control_plane_ports }}"
      when: "'control_plane' in group_names"

    - name: 0-9. Reload firewalld
      ansible.builtin.command: firewall-cmd --reload
      become: true
      changed_when: false

# =====================================================================
# 1. MetalLB + NGINX í…ŒìŠ¤íŠ¸ ì•± + Ingress ë°°í¬
# =====================================================================
- name: 1. Deploy MetalLB + NGINX app + Ingress
  hosts: control1
  gather_facts: false

  # ì´ë¯¸ ansible.cfg ì— remote_user = kubeuser ë¼ì„œ become ë¶ˆí•„ìš”
  roles:
    - metallb
