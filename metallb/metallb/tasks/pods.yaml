---
- name: 환경별 설정 파일 로드
  include_vars:
    file: "pods_vars.yaml"

# --- 0. Pre-Checks ---
- name: 01_CHECK - Wait for Kubernetes API to be reachable
  ansible.builtin.command: kubectl version --output=json

- name: 02_CHECK - Wait for CoreDNS to be Ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    --namespace kube-system
    -l k8s-app=kube-dns
    --timeout=300s

# --- 1. MetalLB Installation ---
- name: 10_METALLB_GET - Download MetalLB manifests
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml"
    dest: "/tmp/metallb.yaml"
  become: true

- name: 11_METALLB_APPLY - Apply MetalLB manifest
  ansible.builtin.command: kubectl apply -f /tmp/metallb.yaml

- name: 12_METALLB_WAIT - Wait for Controller pods Ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    -n metallb-system
    -l component=controller
    --timeout=300s

- name: 13_METALLB_WAIT - Wait for Speaker pods Ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    -n metallb-system
    -l component=speaker
    --timeout=300s

# --- 2. MetalLB Config & Webhook Bypass ---
- name: 20_METALLB_CONF - Create MetalLB Config template
  ansible.builtin.template:
    src: metallb-config.yaml.j2 # 고유 파일명 사용
    dest: /tmp/metallb-config.yaml

- name: 21_METALLB_WEBHOOK_DEL - Delete ALL MetalLB Webhook Configurations (Bypass Network Error)
  ansible.builtin.shell: |
    kubectl delete validatingwebhookconfigurations metallb-webhook-configuration --ignore-not-found || true
    kubectl delete mutatingwebhookconfigurations metallb-webhook-configuration --ignore-not-found || true
  ignore_errors: yes

- name: 22_METALLB_APPLY_CONFIG - Apply MetalLB Config with Webhook Bypass
  ansible.builtin.command: kubectl apply -f /tmp/metallb-config.yaml
  register: metallb_apply_status
  retries: 5
  delay: 10
  # rc 값 대신 Webhook 오류 메시지가 없을 때까지 재시도
  until: "'failed calling webhook' not in metallb_apply_status.stderr"

# --- 3. NGINX Application Deployment ---
- name: 30_APP_DEPLOY - Deploy NGINX web application
  ansible.builtin.template:
    src: app-deployment.yaml.j2 # 고유 파일명 사용
    dest: /tmp/app-deployment.yaml

- name: 31_APP_APPLY - Apply app deployment
  ansible.builtin.command: kubectl apply -f /tmp/app-deployment.yaml

- name: 32_APP_WAIT - Wait for app pods to be Ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    -l app={{ app_name }}
    --timeout=300s

- name: 33_SERVICE_APPLY - Create web service template
  ansible.builtin.template:
    src: web-service.yaml.j2 # 고유 파일명 사용
    dest: /tmp/web-service.yaml

- name: 34_SERVICE_APPLY - Apply web service
  ansible.builtin.command: kubectl apply -f /tmp/web-service.yaml

# --- 4. Ingress Controller Installation ---
- name: 40_INGRESS_INSTALL - Install NGINX Ingress Controller
  ansible.builtin.command: >
    kubectl apply -f
    https://raw.githubusercontent.com/kubernetes/ingress-nginx/{{ ingress_controller_version }}/deploy/static/provider/cloud/deploy.yaml

- name: 41_INGRESS_WAIT - Wait for Ingress controller pods Ready
  ansible.builtin.command: >
    kubectl wait --for=condition=Ready pod
    -n ingress-nginx
    -l app.kubernetes.io/component=controller
    --timeout=600s

# --- 5. Ingress Config & Webhook Bypass ---
- name: 50_INGRESS_WEBHOOK_DEL - Delete ALL Ingress Webhook Configurations (Critical Bypass)
  ansible.builtin.shell: |
    kubectl delete validatingwebhookconfigurations ingress-nginx-admission --ignore-not-found || true
    kubectl delete mutatingwebhookconfigurations ingress-nginx-admission --ignore-not-found || true
  ignore_errors: yes

- name: 51_INGRESS_PAUSE - Pause for Kubernetes API to fully recognize Webhook deletion (10 seconds)
  ansible.builtin.pause:
    seconds: 10

- name: 52_INGRESS_CONF - Deploy Ingress template
  ansible.builtin.template:
    src: web-ingress.yaml.j2 # 고유 파일명 사용
    dest: /tmp/web-ingress.yaml

- name: 53_INGRESS_APPLY - Apply Ingress with Webhook Bypass
  ansible.builtin.command: kubectl apply -f /tmp/web-ingress.yaml
  register: ingress_apply_status
  retries: 5
  delay: 10
  # rc 값 대신 Webhook 오류 메시지가 없을 때까지 재시도
  until: "'failed calling webhook' not in ingress_apply_status.stderr"

# --- 6. Cleanup & Results ---
- name: 60_CLEANUP - Clean up temp manifests
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /tmp/metallb.yaml
    - /tmp/metallb-config.yaml
    - /tmp/app-deployment.yaml
    - /tmp/web-service.yaml
    - /tmp/web-ingress.yaml

# [수정됨] IP가 할당될 때까지, 그리고 잘못된 Node IP(172.16.6.1)가 아닐 때까지 대기
- name: 61_RESULT - Get External IP for Ingress (Wait for MetalLB IP)
  ansible.builtin.command: kubectl get ingress {{ ingress_name }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
  register: ingress_ip
  # 1. IP가 비어있지 않아야 함 (!= "")
  # 2. 잘못 잡히는 Gateway/Node IP(172.16.6.1)가 아니어야 함
  until: 
    - ingress_ip.stdout != ""
    - ingress_ip.stdout != "172.16.6.1"
  retries: 20   # 5초 간격으로 20번 시도 (총 100초 대기)
  delay: 5
  ignore_errors: yes 

- name: 62_RESULT - Display Access Information
  ansible.builtin.debug:
    msg: "배포 완료! Ingress Host: {{ ingress_host }}, 할당된 IP: {{ ingress_ip.stdout | default('할당 실패(확인 필요)') }}. curl -H 'Host: {{ ingress_host }}' http://{{ ingress_ip.stdout }} 로 접근하세요."
